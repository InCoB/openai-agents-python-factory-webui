# Agent Builder Module: Technical Architecture & Implementation Documentation

## 1. Module Structure and Organization

### 1.1 Directory Structure

```
aigen/
├── __init__.py                      # Package exports
├── services/                        # Core service components
│   ├── __init__.py                  # Service exports
│   ├── models.py                    # Data models
│   ├── generator.py                 # Code generation service
│   ├── registration.py              # Agent registration service
│   ├── testing.py                   # Agent testing service
│   └── persistence.py               # Configuration persistence
├── templates/                       # Jinja2 templates
│   ├── __init__.py                  # Package marker
│   ├── agent_class.py.jinja         # Agent class template
│   └── agent_config.yaml.jinja      # YAML config template
├── ui/                              # User interface components
│   ├── __init__.py                  # UI exports
│   ├── agent_builder.py             # Builder interface
│   ├── agent_manager.py             # Management interface
│   └── gradio_app.py                # Main application
└── agents/                          # Agent storage
    ├── __init__.py                  # Agent exports
    ├── custom/                      # Generated agents
    │   └── __init__.py              # Package marker
    └── config/                      # Agent configurations
        └── __init__.py              # Package marker
```

### 1.2 Key Dependencies

| Dependency | Purpose | Files |
|------------|---------|-------|
| `jinja2` | Template rendering | `services/generator.py` |
| `pydantic` | Data validation | `services/models.py` |
| `gradio` | Web interface | `ui/*.py` |
| `pyyaml` | Configuration storage | `services/persistence.py` |
| `asyncio` | Asynchronous operations | `services/testing.py` |

## 2. Core Components and Files

### 2.1 Data Models (`aigen/services/models.py`)

The foundation of the system is the `AgentConfiguration` data model that defines and validates agent properties:

```python
class AgentRole(str, Enum):
    """Enum for agent roles."""
    RESEARCH = "RESEARCH"
    WRITER = "WRITER"
    EDITOR = "EDITOR"
    # ...

class AgentConfiguration(BaseModel):
    """Data model for agent configuration."""
    agent_type: str = Field(...)
    name: str = Field(...)
    role: AgentRole = Field(AgentRole.CUSTOM)
    # ...
```

**Key Responsibilities:**
- Defines the structure for agent configurations
- Provides validation logic for agent properties
- Maps UI role values to framework roles

### 2.2 Generator Service (`aigen/services/generator.py`)

Transforms agent configurations into executable code using Jinja2 templates:

```python
class AgentGeneratorService:
    """Service for generating agent code from configurations."""
    
    def __init__(self, template_dir: Optional[str] = None) -> None:
        # Setup template environment
        
    def generate_agent_code(self, config: AgentConfiguration) -> Tuple[bool, str]:
        """Generate Python code for an agent class."""
        # Render agent class template
        
    def generate_yaml_config(self, config: AgentConfiguration) -> Tuple[bool, str]:
        """Generate YAML configuration for an agent."""
        # Render YAML config template
```

**Key Responsibilities:**
- Manages template loading and environment setup
- Renders templates with agent configurations
- Handles template errors and fallbacks

### 2.3 Registration Service (`aigen/services/registration.py`)

Dynamically registers generated agents with the framework:

```python
class AgentRegistrationService:
    """Service for registering agents with the framework."""
    
    def register_agent_type(self, config: AgentConfiguration, code: str) -> Tuple[bool, str]:
        """Register a new agent type with the framework."""
        # Attempt code-based registration
        # Fall back to config-based if needed
        
    def _register_from_code(self, config: AgentConfiguration, code: str) -> Tuple[bool, str]:
        """Register agent by generating and loading Python code."""
        # Write code to file
        # Dynamically import module
        # Register with factory system
```

**Key Responsibilities:**
- Writes generated code to disk
- Dynamically loads agent modules
- Registers agents with the factory system
- Provides multi-strategy registration with fallbacks

### 2.4 Testing Service (`aigen/services/testing.py`)

Validates agent implementations before deployment:

```python
class AgentTestingService:
    """Service for testing agents before deployment."""
    
    def __init__(self, timeout: float = 30.0) -> None:
        """Initialize with execution timeout."""
        
    async def test_agent(self, agent_type: str, test_input: str) -> Dict[str, Any]:
        """Test an agent with sample input."""
        # Create agent instance
        # Execute with timeout protection
        # Return results
```

**Key Responsibilities:**
- Creates agent instances for testing
- Provides timeout protection
- Captures and formats execution results

### 2.5 Persistence Service (`aigen/services/persistence.py`)

Manages storage and retrieval of agent configurations:

```python
class AgentPersistenceService:
    """Service for persisting and loading agent configurations."""
    
    def save_agent_config(self, config: AgentConfiguration) -> Tuple[bool, str]:
        """Save agent configuration to disk."""
        # Create backups
        # Serialize and write YAML
        
    def load_agent_config(self, agent_type: str) -> Tuple[bool, Optional[AgentConfiguration], str]:
        """Load agent configuration from disk."""
        # Read and deserialize YAML
        
    def list_saved_agents(self) -> List[Dict[str, str]]:
        """List all saved agent configurations with metadata."""
        # Scan directory
        # Load each configuration
```

**Key Responsibilities:**
- Saves configurations to YAML files
- Creates backups before overwriting
- Loads and validates configurations
- Lists available agent configurations

### 2.6 Jinja2 Templates

#### Agent Class Template (`aigen/templates/agent_class.py.jinja`)

```jinja
from typing import Dict, Any, Optional
import asyncio

from agents import Agent, Runner
from agents.model_settings import ModelSettings

from aigen.agents.base import AgentBase, AgentRole, AgentResponse
from aigen.core.context import Context
from aigen.core.errors import AgentError
from aigen.core.logging import get_logger

{% if config.output_type %}
from typing import List, Optional, Union, Dict, Any
from pydantic import BaseModel
{% endif %}

logger = get_logger("{{ config.agent_type }}_agent")

{% if config.output_type %}
{{ config.output_type }}
{% endif %}

class {{ config.name | replace(" ", "") }}Agent(AgentBase):
    """
    {{ config.name }} - {{ config.role }} agent.
    
    This agent is automatically generated by the agent builder.
    
    {{ config.instructions | truncate(200) }}
    """
    # ... Agent implementation ...
```

#### YAML Config Template (`aigen/templates/agent_config.yaml.jinja`)

```jinja
# Agent Configuration for {{ config.name }}
agent_type: {{ config.agent_type }}
name: {{ config.name }}
role: {{ framework_role }}
instructions: |
  {{ config.instructions | indent(2) }}
model: {{ config.model }}
parameters:
  temperature: {{ config.parameters.get("temperature", 0.7) }}
  {% if config.parameters.get("max_tokens") %}
  max_tokens: {{ config.parameters.get("max_tokens") }}
  {% endif %}
tools:
{% for tool in config.tools %}
  - {{ tool }}
{% endfor %}
handoffs:
{% for handoff in config.handoffs %}
  - {{ handoff }}
{% endfor %}
{% if config.output_type %}
output_type: |
  {{ config.output_type | indent(2) }}
{% endif %}
```

**Key Responsibilities:**
- Define the structure of generated agents
- Include dynamic placeholders for agent properties
- Handle conditional sections based on agent configuration

### 2.7 UI Components

#### Agent Builder UI (`aigen/ui/agent_builder.py`)

```python
class AgentBuilderUI:
    """UI components for agent builder."""
    
    def __init__(self) -> None:
        """Initialize services."""
        self.generator = AgentGeneratorService()
        self.registrar = AgentRegistrationService()
        self.tester = AgentTestingService()
        self.persistence = AgentPersistenceService()
    
    def build_ui(self) -> gr.Tab:
        """Build the agent builder UI tab."""
        # Create form elements
        # Connect event handlers
        # Return tab component
```

#### Agent Manager UI (`aigen/ui/agent_manager.py`)

```python
class AgentManagerUI:
    """UI components for agent management."""
    
    def build_ui(self) -> gr.Tab:
        """Build the agent manager UI tab."""
        # Create list view
        # Add management controls
        # Connect event handlers
```

#### Main Application (`aigen/ui/gradio_app.py`)

```python
class GradioApp:
    """Main Gradio application."""
    
    def build_ui(self) -> gr.Blocks:
        """Build the Gradio UI."""
        # Create tabs structure
        # Add builder and manager tabs
        # Configure application settings
```

**Key Responsibilities:**
- Create user interface components
- Connect UI events to service methods
- Handle input validation and user feedback

## 3. Component Interactions and Data Flow

### 3.1 Agent Creation Flow

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    User     │     │   Builder   │     │  Generator  │     │ Registration │     │ Persistence │
│  Interface  │     │    UI       │     │   Service   │     │   Service    │     │   Service   │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                   │                   │
       │  Input Agent      │                   │                   │                   │
       │  Configuration    │                   │                   │                   │
       │ ─────────────────>│                   │                   │                   │
       │                   │                   │                   │                   │
       │                   │  Validate Inputs  │                   │                   │
       │                   │ ────────┐         │                   │                   │
       │                   │         │         │                   │                   │
       │                   │ <───────┘         │                   │                   │
       │                   │                   │                   │                   │
       │                   │  Generate Code    │                   │                   │
       │                   │ ─────────────────>│                   │                   │
       │                   │                   │                   │                   │
       │                   │                   │  Render Templates │                   │
       │                   │                   │ ────────┐         │                   │
       │                   │                   │         │         │                   │
       │                   │                   │ <───────┘         │                   │
       │                   │                   │                   │                   │
       │                   │  Generated Code   │                   │                   │
       │                   │ <─────────────────│                   │                   │
       │                   │                   │                   │                   │
       │                   │  Register Agent   │                   │                   │
       │                   │ ───────────────────────────────────> │                   │
       │                   │                   │                   │                   │
       │                   │                   │                   │  Write Code File  │
       │                   │                   │                   │ ────────┐         │
       │                   │                   │                   │         │         │
       │                   │                   │                   │ <───────┘         │
       │                   │                   │                   │                   │
       │                   │                   │                   │  Load Module      │
       │                   │                   │                   │ ────────┐         │
       │                   │                   │                   │         │         │
       │                   │                   │                   │ <───────┘         │
       │                   │                   │                   │                   │
       │                   │                   │                   │  Register with    │
       │                   │                   │                   │  Factory System   │
       │                   │                   │                   │ ────────┐         │
       │                   │                   │                   │         │         │
       │                   │                   │                   │ <───────┘         │
       │                   │                   │                   │                   │
       │                   │  Save Config      │                   │                   │
       │                   │ ───────────────────────────────────────────────────────> │
       │                   │                   │                   │                   │
       │                   │                   │                   │                   │  Write YAML File
       │                   │                   │                   │                   │ ────────┐
       │                   │                   │                   │                   │         │
       │                   │                   │                   │                   │ <───────┘
       │                   │                   │                   │                   │
       │                   │  Registration     │                   │                   │
       │                   │  Result           │                   │                   │
       │  Success/Failure  │ <─────────────────────────────────────────────────────────
       │ <─────────────────│                   │                   │                   │
       │                   │                   │                   │                   │
```

### 3.2 Agent Testing Flow

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    User     │     │   Builder   │     │   Testing   │     │   Agent     │
│  Interface  │     │    UI       │     │   Service   │     │  Instance   │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                   │
       │  Agent Type &     │                   │                   │
       │  Test Input       │                   │                   │
       │ ─────────────────>│                   │                   │
       │                   │                   │                   │
       │                   │  Test Agent       │                   │
       │                   │ ─────────────────>│                   │
       │                   │                   │                   │
       │                   │                   │  Create Agent     │
       │                   │                   │ ─────────────────>│
       │                   │                   │                   │
       │                   │                   │  Agent Instance   │
       │                   │                   │ <─────────────────│
       │                   │                   │                   │
       │                   │                   │  Execute Agent    │
       │                   │                   │ ─────────────────>│
       │                   │                   │                   │
       │                   │                   │  Execute Result   │
       │                   │                   │ <─────────────────│
       │                   │                   │                   │
       │                   │  Test Result      │                   │
       │                   │ <─────────────────│                   │
       │                   │                   │                   │
       │  Test Output      │                   │                   │
       │ <─────────────────│                   │                   │
       │                   │                   │                   │
```

### 3.3 Agent Management Flow

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    User     │     │   Manager   │     │ Registration │     │ Persistence │
│  Interface  │     │    UI       │     │   Service    │     │   Service   │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                   │
       │  Load Agent List  │                   │                   │
       │ ─────────────────>│                   │                   │
       │                   │                   │                   │
       │                   │  List Agents      │                   │
       │                   │ ───────────────────────────────────> │
       │                   │                   │                   │
       │                   │                   │                   │  Scan Directory
       │                   │                   │                   │ ────────┐
       │                   │                   │                   │         │
       │                   │                   │                   │ <───────┘
       │                   │                   │                   │
       │                   │  Agent List       │                   │
       │                   │ <─────────────────────────────────────│
       │                   │                   │                   │
       │  Agent List       │                   │                   │
       │ <─────────────────│                   │                   │
       │                   │                   │                   │
       │  Delete Agent     │                   │                   │
       │ ─────────────────>│                   │                   │
       │                   │                   │                   │
       │                   │  Unregister Agent │                   │
       │                   │ ─────────────────>│                   │
       │                   │                   │                   │
       │                   │                   │  Remove From      │
       │                   │                   │  Registry         │
       │                   │                   │ ────────┐         │
       │                   │                   │         │         │
       │                   │                   │ <───────┘         │
       │                   │                   │                   │
       │                   │                   │  Delete Files     │
       │                   │                   │ ────────┐         │
       │                   │                   │         │         │
       │                   │                   │ <───────┘         │
       │                   │                   │                   │
       │                   │  Delete Config    │                   │
       │                   │ ───────────────────────────────────> │
       │                   │                   │                   │
       │                   │                   │                   │  Delete YAML
       │                   │                   │                   │ ────────┐
       │                   │                   │                   │         │
       │                   │                   │                   │ <───────┘
       │                   │                   │                   │
       │                   │  Operation Result │                   │
       │  Delete Result    │ <─────────────────────────────────────│
       │ <─────────────────│                   │                   │
       │                   │                   │                   │
```

## 4. Implementation Details

### 4.1 Code Generation Process (`services/generator.py`)

The code generation process has three key phases:

1. **Template Loading**: Templates are loaded from the filesystem with fallback behaviors
   ```python
   def __init__(self, template_dir: Optional[str] = None) -> None:
       # Get the template directory
       if template_dir is None:
           template_dir = os.path.join(
               os.path.dirname(os.path.dirname(os.path.abspath(__file__))),
               'templates'
           )
       
       self.template_dir = template_dir
       
       # Set up Jinja environment
       self.env = Environment(
           loader=FileSystemLoader(template_dir),
           trim_blocks=True,
           lstrip_blocks=True,
           keep_trailing_newline=True
       )
   ```

2. **Template Rendering**: Agent configurations are passed to Jinja2 for rendering
   ```python
   def generate_agent_code(self, config: AgentConfiguration) -> Tuple[bool, str]:
       try:
           template = self.env.get_template("agent_class.py.jinja")
           code = template.render(
               config=config,
               framework_role=AgentConfiguration.to_framework_role(config.role.value)
           )
           return True, code
       except Exception as e:
           return False, f"# Error generating code: {str(e)}"
   ```

3. **Error Handling**: Comprehensive error capturing ensures graceful failure
   ```python
   try:
       # Template rendering logic
   except (exceptions.TemplateError, exceptions.TemplateNotFound) as e:
       error_msg = f"Template error: {str(e)}"
       logger.error(error_msg)
       return False, f"# Error generating code: {error_msg}"
   except Exception as e:
       error_msg = f"Error generating agent code: {str(e)}"
       logger.error(error_msg)
       return False, f"# Error generating code: {error_msg}"
   ```

### 4.2 Agent Registration Process (`services/registration.py`)

The registration implements a three-step process:

1. **Code Validation**: Generated code is validated before writing to disk
   ```python
   # Validate code syntax
   try:
       compile(code, module_path, 'exec')
   except SyntaxError as se:
       line_no = se.lineno if hasattr(se, 'lineno') else '?'
       return False, f"Syntax error in generated code at line {line_no}: {str(se)}"
   ```

2. **Module Loading**: Dynamic module loading with proper system integration
   ```python
   # Import the module
   spec = importlib.util.spec_from_file_location(module_name, module_path)
   if not spec or not spec.loader:
       return False, "Failed to create module specification"
       
   module = importlib.util.module_from_spec(spec)
   sys.modules[module_name] = module
   spec.loader.exec_module(module)
   ```

3. **Factory Registration**: Registration with the agent factory system
   ```python
   # Register with factory system
   register_agent_factory(
       config.agent_type,
       lambda agent_id=None, **kwargs: agent_class(
           agent_id=agent_id or config.agent_type, 
           **kwargs
       ),
       {"description": config.name}
   )
   ```

### 4.3 Testing with Timeout Protection (`services/testing.py`)

Agent testing includes timeout protection to prevent hanging:

```python
try:
    # Execute agent with timeout protection
    coro = agent.execute(test_input, context or {})
    response = await asyncio.wait_for(coro, timeout=self.timeout)
    
    return {
        "success": response.get("success", False),
        "content": response.get("content", "No content returned"),
        "metadata": response.get("metadata", {})
    }
except asyncio.TimeoutError:
    return {
        "success": False,
        "error": f"Agent execution timed out after {self.timeout} seconds",
        "content": "The agent took too long to respond"
    }
```

### 4.4 UI Event Handling (`ui/agent_builder.py`)

The UI connects user interactions to service functions:

```python
# Connect events
generate_btn.click(
    self.generate_code,
    inputs=[
        agent_type, agent_name, agent_role, agent_model, instructions,
        temperature, max_tokens, tools, handoffs, use_output_type, output_type_code
    ],
    outputs=[preview_code, preview_yaml]
)

register_btn.click(
    self.register_agent,
    inputs=[
        agent_type, agent_name, agent_role, agent_model, instructions,
        temperature, max_tokens, tools, handoffs, use_output_type, 
        output_type_code, preview_code
    ],
    outputs=[registration_result]
)

test_btn.click(
    self.test_agent,
    inputs=[agent_type, test_input],
    outputs=[test_output]
)
```

## 5. Integration with Main Application

### 5.1 Application Initialization (`ui/gradio_app.py`)

The main application integrates all components:

```python
class GradioApp:
    """Main Gradio application."""
    
    def __init__(
        self,
        title: str = "AI Gen Framework",
        description: str = "Generate and run AI agents"
    ) -> None:
        self.title = title
        self.description = description
        
        # Initialize UI components
        self.agent_builder = AgentBuilderUI()
        self.agent_manager = AgentManagerUI()
    
    def build_ui(self) -> gr.Blocks:
        """Build the Gradio UI."""
        with gr.Blocks(title=self.title, theme=gr.themes.Default()) as app:
            gr.Markdown(f"# {self.title}")
            gr.Markdown(self.description)
            
            with gr.Tabs() as tabs:
                # Add Agent Builder tab
                self.agent_builder.build_ui()
                
                # Add Agent Management tab
                self.agent_manager.build_ui()
                
                # Other tabs...
            
            return app
```

### 5.2 Running the Application (`run.py`)

The entry point configures and launches the application:

```python
def main():
    """Run the application."""
    parser = argparse.ArgumentParser(description="Run the AI Generator application")
    parser.add_argument(
        "--host", 
        type=str, 
        default="127.0.0.1", 
        help="Hostname to run the server on"
    )
    parser.add_argument(
        "--port", 
        type=int, 
        default=7860, 
        help="Port to run the server on"
    )
    parser.add_argument(
        "--share", 
        action="store_true", 
        help="Whether to create a public link"
    )
    args = parser.parse_args()
    
    app = GradioApp(
        title="AI Generator Framework",
        description="Create and manage custom AI agents"
    )
    
    app.launch(
        server_name=args.host,
        server_port=args.port,
        share=args.share
    )

if __name__ == "__main__":
    main()
```

## 6. Best Practices and Considerations

### 6.1 Error Management Strategy

The implementation follows a multi-layered error management strategy:

1. **Service Layer**: Each service method returns success/failure flags with detailed messages
   ```python
   return True, "Success message"  # or
   return False, "Detailed error explanation"
   ```

2. **UI Layer**: Error messages are displayed to users with clear formatting
   ```python
   yield f"❌ {error_msg}"  # Error formatting
   ```

3. **Logging**: All errors are logged with appropriate severity levels
   ```python
   logger.error(f"Error generating agent code: {str(e)}")
   ```

### 6.2 Template Debugging and Maintenance

Templates are stored as external files for easier debugging and maintenance:

1. **Development Workflow**: Edit templates directly without rebuilding the application
2. **Syntax Highlighting**: IDEs provide proper syntax highlighting for Jinja2 templates
3. **Version Control**: Templates can be tracked separately in version control
4. **Linting Integration**: Templates avoid linting errors in Python code

### 6.3 File Operations Safety

The system implements safe file operations with backup strategies:

```python
# Create a backup if the file already exists
if os.path.exists(file_path):
    backup_path = f"{file_path}.bak"
    try:
        shutil.copy2(file_path, backup_path)
        logger.info(f"Created backup at {backup_path}")
    except Exception as e:
        logger.warning(f"Failed to create backup: {str(e)}")

```

## 7. Agent Deletion 

### 7.1 How Agent Deletion Works

When you delete an agent in the AI Generator Framework, the system performs a three-step process:

1. **Delete the configuration file** - Removes the YAML configuration from `aigen/agents/config/`
2. **Delete the implementation file** - Removes the Python code file from `aigen/agents/custom/`
3. **Unregister from memory** - Removes the agent from the runtime registry

### 7.2 Deletion Process Flow

```
┌───────────────┐     ┌──────────────────┐     ┌────────────────┐
│ Delete Config │ ──► │ Delete Python    │ ──► │ Unregister     │
│ File (.yaml)  │     │ Files (.py, .pyc)│     │ from Registry  │
└───────────────┘     └──────────────────┘     └────────────────┘
```

### 7.3 Code Implementation

The main deletion logic in `agent_manager.py`:

```python
async def delete_agent(self, agent_type: str) -> Dict[str, Any]:
    """Delete an agent."""
    try:
        if not agent_type:
            return {"status": "error", "message": "❌ No agent selected"}
        
        # Step 1: Delete the configuration file
        config_success, config_message = self.persistence.delete_agent_config(agent_type)
        
        if not config_success:
            return {"status": "error", "message": f"❌ Failed to delete agent configuration: {config_message}"}
        
        # Step 2: Delete the implementation file
        try:
            implementation_path = os.path.join(
                os.path.dirname(os.path.dirname(os.path.abspath(__file__))),
                'agents',
                'custom',
                f"{agent_type}.py"
            )
            if os.path.exists(implementation_path):
                os.unlink(implementation_path)
                
            # Also clean up compiled and cached files...
        except Exception as e:
            logger.warning(f"Error removing implementation file: {str(e)}")
        
        # Step 3: Unregister from memory registry
        try:
            success, message = self.registrar.unregister_agent(agent_type)
            # Handle results...
        except Exception as e:
            logger.warning(f"Error unregistering agent: {str(e)}")
            
        return {"status": "success", "message": f"✅ Agent '{agent_type}' deleted successfully"}
        
    except Exception as e:
        error_msg = f"Error deleting agent: {str(e)}"
        logger.error(error_msg)
        return {"status": "error", "message": f"❌ {error_msg}"}
```

### 7.4 UI Implementation

The user interface provides a dropdown for selecting agents to delete:

```python
# In the build_ui method:
agent_dropdown = gr.Dropdown(
    label="Select Agent Type",
    choices=self.get_agent_type_choices(),
    interactive=True
)

delete_btn = gr.Button("Delete Selected Agent", variant="stop")

# Refresh function to update UI after deletion
def on_delete_and_refresh(agent_type: str):
    result = asyncio.run(self.delete_agent(agent_type))
    agents_list = self.load_agent_list()
    agent_choices = [row[0] for row in agents_list if row[0]]
    return result, agents_list, gr.Dropdown(choices=agent_choices, value=None)
```

### 7.5 Best Practices

1. **Regular Cleanup**: Periodically check and clean up any orphaned agent files
2. **Proper Unregistration**: Always use the UI to delete agents rather than manually removing files
3. **Error Handling**: The system will attempt all deletion steps, even if some fail
4. **Backup Files**: Configuration backups are stored as `.yaml.bak` files in case recovery is needed 

## 8. Advanced Implementation Features

### 8.1 Security and Validation

The system implements multi-layered validation to ensure security and correctness:

1. **Agent Type Validation**: Enforces naming conventions and prevents duplicates
   ```python
   AGENT_TYPE_PATTERN: ClassVar[re.Pattern] = re.compile(r'^[a-z][a-z0-9_]*$')
   
   @staticmethod
   def validate_agent_type(v: str) -> str:
       """Validate agent type."""
       if not v:
           raise ValueError("Agent type must not be empty")
       
       if not AgentConfiguration.AGENT_TYPE_PATTERN.match(v):
           raise ValueError(
               "Agent type must start with a lowercase letter and "
               "contain only lowercase letters, numbers, and underscores"
           )
       
       return v
   ```

2. **Code Security Checks**: The registration service prevents potentially harmful code
   ```python
   # Check for unsafe import patterns
   unsafe_patterns = [
       r'os\.system\(',
       r'subprocess\.',
       r'shutil\.rmtree\(',
       r'__import__\(',
       r'eval\(',
       r'exec\('
   ]
   
   for pattern in unsafe_patterns:
       if re.search(pattern, code):
           return False, f"Unsafe pattern detected in code: {pattern}"
   ```

3. **Template Fallback Mechanism**: The generator provides default templates if files are missing
   ```python
   def _ensure_default_templates(self) -> None:
       """Ensure default templates exist."""
       # Check for agent class template
       class_template_path = os.path.join(self.template_dir, "agent_class.py.jinja")
       if not os.path.exists(class_template_path):
           with open(class_template_path, "w", encoding="utf-8") as f:
               f.write(self._get_agent_class_template_fallback())
               
       # Check for agent config template
       config_template_path = os.path.join(self.template_dir, "agent_config.yaml.jinja")
       if not os.path.exists(config_template_path):
           with open(config_template_path, "w", encoding="utf-8") as f:
               f.write(self._get_agent_config_template_fallback())
   ```

### 8.2 Dynamic UI Integration

The agent builder implements sophisticated UI handling for a seamless user experience:

1. **Real-time Validation**: Form fields are validated as the user types
   ```python
   def on_agent_type_change(agent_type: str) -> Dict[str, Any]:
       """Validate agent type as user types."""
       valid, error = self.validate_agent_type(agent_type)
       return {
           "valid": valid,
           "error": error if not valid else "",
           "color": "green" if valid else "red"
       }
   ```

2. **Conditional UI Elements**: Interface elements appear/disappear based on selections
   ```python
   def toggle_output_type(use_output: bool) -> Dict[str, Any]:
       """Toggle the output type code visibility."""
       return {
           "visible": use_output,
           "value": "class AgentOutput(BaseModel):\n    content: str\n    confidence: float = 0.0" if use_output else ""
       }
   ```

3. **Dynamic Tool Loading**: Available tools are loaded at runtime from the registry
   ```python
   def get_available_tools(self) -> List[str]:
       """Get list of available tools."""
       try:
           from aigen.tools.factory import tool_registry
           return sorted(tool_registry.list())
       except ImportError:
           logger.warning("Failed to import tool registry")
           return []
   ```

### 8.3 Custom YAML Handling

The persistence service uses custom YAML handling to properly serialize/deserialize agent configurations:

```python
# Configure YAML to handle AgentRole enum properly
class SafeAgentYamlLoader(yaml.SafeLoader):
    """Custom YAML loader that handles AgentRole enums."""
    pass

def agent_role_constructor(loader, node):
    """Convert YAML scalar to AgentRole enum."""
    value = loader.construct_scalar(node)
    try:
        return AgentRole(value)
    except ValueError:
        logger.warning(f"Invalid AgentRole value: {value}, defaulting to CUSTOM")
        return AgentRole.CUSTOM

# Register constructor for role values
SafeAgentYamlLoader.add_constructor('tag:yaml.org,2002:str', lambda loader, node: loader.construct_scalar(node))
yaml.add_representer(AgentRole, lambda dumper, data: dumper.represent_scalar('tag:yaml.org,2002:str', data.value))
```

This custom handling ensures that:
- Agent roles are properly serialized as strings in YAML
- When loaded, they are properly converted back to AgentRole enum values
- Backward compatibility is maintained for previously saved configurations
- Invalid values are gracefully handled with reasonable defaults


## 9. Agent Deletion 

## 9.1 How Agent Deletion Works

When you delete an agent in the AI Generator Framework, the system performs a three-step process:

1. **Delete the configuration file** - Removes the YAML configuration from `aigen/agents/config/`
2. **Delete the implementation file** - Removes the Python code file from `aigen/agents/custom/`
3. **Unregister from memory** - Removes the agent from the runtime registry

### 9.2 Deletion Process Flow

```
┌───────────────┐     ┌──────────────────┐     ┌────────────────┐
│ Delete Config │ ──► │ Delete Python    │ ──► │ Unregister     │
│ File (.yaml)  │     │ Files (.py, .pyc)│     │ from Registry  │
└───────────────┘     └──────────────────┘     └────────────────┘
```

## 9.3 Code Implementation

The main deletion logic in `agent_manager.py`:

```python
async def delete_agent(self, agent_type: str) -> Dict[str, Any]:
    """Delete an agent."""
    try:
        if not agent_type:
            return {"status": "error", "message": "❌ No agent selected"}
        
        # Step 1: Delete the configuration file
        config_success, config_message = self.persistence.delete_agent_config(agent_type)
        
        if not config_success:
            return {"status": "error", "message": f"❌ Failed to delete agent configuration: {config_message}"}
        
        # Step 2: Delete the implementation file
        try:
            implementation_path = os.path.join(
                os.path.dirname(os.path.dirname(os.path.abspath(__file__))),
                'agents',
                'custom',
                f"{agent_type}.py"
            )
            if os.path.exists(implementation_path):
                os.unlink(implementation_path)
                
            # Also clean up compiled and cached files...
        except Exception as e:
            logger.warning(f"Error removing implementation file: {str(e)}")
        
        # Step 3: Unregister from memory registry
        try:
            success, message = self.registrar.unregister_agent(agent_type)
            # Handle results...
        except Exception as e:
            logger.warning(f"Error unregistering agent: {str(e)}")
            
        return {"status": "success", "message": f"✅ Agent '{agent_type}' deleted successfully"}
        
    except Exception as e:
        error_msg = f"Error deleting agent: {str(e)}"
        logger.error(error_msg)
        return {"status": "error", "message": f"❌ {error_msg}"}
```

## 9.4 UI Implementation

The user interface provides a dropdown for selecting agents to delete:

```python
# In the build_ui method:
agent_dropdown = gr.Dropdown(
    label="Select Agent Type",
    choices=self.get_agent_type_choices(),
    interactive=True
)

delete_btn = gr.Button("Delete Selected Agent", variant="stop")

# Refresh function to update UI after deletion
def on_delete_and_refresh(agent_type: str):
    result = asyncio.run(self.delete_agent(agent_type))
    agents_list = self.load_agent_list()
    agent_choices = [row[0] for row in agents_list if row[0]]
    return result, agents_list, gr.Dropdown(choices=agent_choices, value=None)
```

## Best Practices

1. **Regular Cleanup**: Periodically check and clean up any orphaned agent files
2. **Proper Unregistration**: Always use the UI to delete agents rather than manually removing files
3. **Error Handling**: The system will attempt all deletion steps, even if some fail
4. **Backup Files**: Configuration backups are stored as `.yaml.bak` files in case recovery is needed 

## 10. Summary

The Agent Builder module implements a comprehensive system for creating, managing, and executing custom AI agents through a web-based interface. The architecture separates concerns across well-defined components:

- **Data Models**: Define and validate agent configurations
- **Generator Service**: Transform configurations into executable code
- **Registration Service**: Dynamically load and register agents
- **Testing Service**: Validate agent functionality
- **Persistence Service**: Store and retrieve agent configurations
- **UI Components**: Provide user interface for agent creation and management

File interactions follow clear patterns with data flowing from UI components through services to the filesystem and agent registry. The template-driven approach provides flexibility and maintainability while enabling dynamic agent creation without manual coding.

This architecture enables non-technical users to create specialized agents while maintaining the robustness and flexibility required for complex AI systems.
